<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>SRFI 222: Compound Objects</title>
    <link href="/favicon.png" rel="icon" sizes="192x192" type="image/png">
    <link rel="stylesheet" href="https://srfi.schemers.org/srfi.css" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1"></head>
  <body>
    <h1><a href="https://srfi.schemers.org/"><img class="srfi-logo" src="https://srfi.schemers.org/srfi-logo.svg" alt="SRFI logo" /></a>222: Compound Objects</h1>

<p>by John Cowan (text), Arvydas Silanskas (implementation)</p>

<h2 id="status">Status</h2>

<p>This SRFI is currently in <em>draft</em> status.  Here is <a href="https://srfi.schemers.org/srfi-process.html">an explanation</a> of each status that a SRFI can hold.  To provide input on this SRFI, please send email to <code><a href="mailto:srfi+minus+222+at+srfi+dotschemers+dot+org">srfi-222@<span class="antispam">nospam</span>srfi.schemers.org</a></code>.  To subscribe to the list, follow <a href="https://srfi.schemers.org/srfi-list-subscribe.html">these instructions</a>.  You can access previous messages via the mailing list <a href="https://srfi-email.schemers.org/srfi-222">archive</a>.</p>
<ul>
  <li>Received: 2021-05-01</li>
  <li>60-day deadline: 2021-05-04</li>
  <li>Draft #1 published: 2021-03-05</li>
  <li>John Cowan's <a href="https://github.com/pre-srfi/compound-objects">personal
    Git repo for this SRFI</a> for reference while the SRFI is in
    <em>draft</em> status (<a href="https://htmlpreview.github.io/?https://github.com/pre-srfi/compound-objects/blob/master/srfi-222.html">preview</a>)</li>
</ul>

<h2 id="abstract">Abstract</h2>

<p>Compound objects are analogous to R6RS compound conditions,
and are suitable for use in creating and handling conditions
on non-R6RS systems, among other purposes.
They encapsulate an immutable sequence of subobjects, which can be
any object except another compound object.
It is possible to implement R6RS compound conditions on top of
compound objects, but not vice versa.
Note that this SRFI does not provide any analogue to R6RS
<i>simple</i> conditions, which are just records.

<h2 id="issues">Issues</h2>

None at this time.

<h2 id="rationale">Rationale</h2>
<p>Compound objects serve as a kind of poor man's multiple inheritance
without the usual complications of multiple inheritance.
A compound object can
be used to represent multiple otherwise unrelated aspects of a value
or situation.
Because they are sequences, they can be used to
represent priorities of interpretation from higher to lower.  Most
of the operations described
in this section treat a non-compound object identically to a compound
object with the simple object as its sole component.</p>


<h2 id="specification">Specification</h2>
<pre><blockquote>
;; The following definitions are referenced in later examples

(define-record-type &lt;student&gt;
  (student admission-year gpa)
  student?
  (admission-year admission-year)
  (gpa gpa))       ; grade-point average
  
(define-record-type &lt;teacher&gt;
  (teacher hire-year salary)
  teacher?
  (hire-year hired)     ; integer year
  (salary salary))  ; annualized
  
(define alyssa (student 1986 4.0))

(define guy (teacher 1981 25000))
</pre></blockquote>

<h3>Procedures</h3>
<p><code>(make-compound </code> <em>obj</em> ...<code>)</code></p>
<p>Create a compound object
containing the objects in <em>obj...</em> in the specified order.
If any object in <em>obj...</em> is itself a compound object,
it is flattened into its subobjects,
which are then added to the compound object in sequence.
[R6RS analogue: <code>condition</code>]
<pre><blockquote>
;; This definition is referenced in later examples

(define george
  (make-compound 
    'teaching-assistant
    (student 1979 3.8)
    (teacher 1983 1000)))
    
<t drowned before the Days began,
until he heard on strands of pearl
where ends the world the music long,
where ever-foaming billows roll
the yellow gold and jewels wan.
He saw the Mountain silent rise
where twilight lies upon the knees
of Valinor, and Eldamar
beheld afar beyond the seas.
A wanderer escaped from night
to haven white he came at last,
to Elvenhome the green and fair
where keen the air, where pale as glass
beneath the Hill of Ilmarin
a-glimmer in a valley sheer
the lamplit towers of Tirion
are mirrored on the Shadowmere.

He tarried there from errantry,
and melodies they taught to him,
and sages old him marvels told,
and harps of gold they brought to him.
They clothed him then in elven-white,
and seven lights before him sent,
as through the Calacirian
to hidden land forlorn he went.
He came unto the timeless halls
where shining fall the countless years,
and endless reigns the Elder King
in Ilmarin on Mountain sheer;
and words unheard were spoken then
of folk of Men and Elven-kin.
Beyond the world were visions showed
forbid to those that dwell therein.

A ship then new they built for him
of mithril and of elvenglass
with crystal keel; no shaven oar
nor sail she bore, on silver mast
the Silmaril as lantern light
and banner bright with living flame
of fire unstained by Elbereth
herself was set, who thither came
and wings immortal made for him,
and laid on him undying doom,
to sail the shoreless skies and come
behind the Sun and light of Moon.

From Evereven's lofty hills
where softly silver fountains fall
his wings him bore, a wandering light,
beyond the mighty Mountain Wall.
From World's End then he turned away,
and yearned again to find afar
his home through shadows journeying,
and burning as an island star
on high above the mists he came,
a distant flame before the Sun,
a wonder ere the waking dawn
where grey the Norland waters run.

And over Middle-earth he passed
and heard at last the weeping sore
of women and of elven-maids
in Elder Days, in years of yore.
But on him mighty doom was laid,
till Moon should fade, an orbed star
to pass, and tarry never more
on Hither Shores where mortals are;
till end of Days on errand high,
a herald bright that never rests,
to bear his burning lamp afar,
the Flammifer of Westernesse.
/blockquote></pre>
<p><code>(compound? </code><em>obj</em><code>)</code></p>
<p>Returns <code>#t</code> if <em>obj</em> is a compound object, and <code>#f</code> otherwise.
[R6RS analogue: <code>condition?</code>]
<pre><blockquote>(compound? alyssa) =&gt; #f
(compound? george) =&gt; #t
</blockquote></pre>
<p><code>(compound-subobjects </code><em>obj</em><code>)</code></p>
<p>If <em>obj</em> is a compound object, returns a list of its subobjects;
otherwise, returns a list containing only <em>obj</em>.
[R6RS analogue: <code>simple-conditions</code>]
<pre><blockquote>(compound-subobjects alyssa) =&gt; (#&lt;student&gt;)
(compound-subobjects george) =&gt; (#&lt;student&gt; #&lt;teacher&gt;)
</blockquote></pre>
<p><code>(compound-length </code><em>obj</em><code>)</code></p>
<p>If <em>obj</em> is a compound object, returns the number of its subobjects as an exact
integer.  Otherwise, it returns 1.</p>
<pre><blockquote>(compound-length alyssa) =&gt; 1
(compound-length george) =&gt; 2
</blockquote></pre>
<p><code>(compound-ref </code><em>obj k</em><code>)</code></p>
<p>If <em>obj</em> is a compound object, returns the <em>k</em>th subobject.
Otherwise, <em>obj</em> is returned.
In either case, it is an error if <em>k</em> is less than
zero, or greater than or equal to <code>(compound-length </code><em>obj</em><code>)</code>.</p>
<pre><blockquote>(compound-ref alyssa 0) =&gt; #&lt;student&gt;
(compound-ref george 1) =&gt; #&lt;teacher&gt;
</blockquote></pre>
<p><code>(compound-map </code><em>mapper obj</em><code>)</code></p>
<p>If <em>obj</em> is a compound object, returns a compound object
whose subobjects result from invoking <em>mapper</em> on each subobject of <em>obj</em>.
Although the subobjects of the result are in the same order as the subobjects of <em>obj</em>,
the order in which <em>mapper</em> is applied to them is unspecified.
If any resulting subobject is itself a compound object, it is flattened into its subobjects,
which are then added to the result in sequence.</p>
<p>If <em>obj</em> is not a compound object, returns a compound object
whose only subobject is the result of applying <em>mapper</em> to <em>obj</em>.</p>
<pre><blockquote>(compound-map - (compound 1 2 3 4 5)) =&gt; #&lt;compound: -1 -2 -3 -4 -5&gt;
</blockquote></pre>
<p><code>(compound-map-&gt;list </code><em>mapper obj</em><code>)</code></p>
<p>If <em>obj</em> is a compound object, returns a list
whose elements result from invoking <em>mapper</em> on each subobject of <em>obj</em>.
Although the elements of the result are in the same order as the subobjects of <em>obj</em>,
the order in which <em>mapper</em> is applied to them is unspecified.</p>
<p>If <em>obj</em> is not a compound object, returns a list
whose only element is the result of applying <em>mapper</em> to <em>obj</em>.</p>
<pre><blockquote>(compound-map-&gt;list - (compound 1 2 3 4 5)) =&gt; (-1 -2 -3 -4 -5)
</blockquote></pre>
<p><code>(compound-filter </code><em>pred</em> <em>obj</em><code>)</code></p>
<p>Returns a compound object
It contains the subobjects of <em>obj</em> that satisfy <em>pred</em>.</p>
<p>If <em>obj</em> is not a compound object, it returns a compound object.
If <em>obj</em> satisfies <em>pred</em>, the only subobject of the result is <em>obj</em>.
If <em>obj</em> does not satisfy <em>pred</em>, the result has no subobjects.</p>
<pre><blockquote>(compound-filter teacher? alyssa) =&gt; #&lt;compound&gt;
(compound-filter teacher? george) =&gt;
  #&lt;compound: #&lt;teacher&gt;&gt;
</blockquote></pre>
<p><code>(compound-predicate </code><em>pred obj</em><code>)</code></p>
<p>If <em>obj</em> satisfies <em>pred</em>,
or is a compound object and
at least one of its subobjects satisfies <em>pred</em>,
then returns <code>#t</code>; otherwise returns <code>#f</code>.
[R6RS analogue: <code>condition-predicate</code>]
<pre><blockquote>
(compound-predicate student? alyssa) =&gt; #f
(compound-predicate teacher? george) =&gt; #t
</blockquote></pre>
<p><code>(compound-access </code><em>predicate accessor default obj</em><code>)</code></p>
<p>If <em>obj</em> satisfies <em>obj</em>, <em>accessor</em> is applied to
<em>obj</em> and the result is returned.
Otherwise, if <em>obj</em> is a compound object, <em>accessor is applied to
the first subobject that satisfies </em>obj</em>, and the result is returned.
Otherwise, <em>default</em> is returned.
[R6RS analogue: <code>condition-accessor</code>]
<pre><blockquote>
(define (uni-member-hire-date obj)
  (compound-access teacher? hired-date #f obj))

(uni-member-hire-date alyssa) =&gt; #f
(uni-member-hire-date guy) =&gt; 1981
(uni-member-hire-date george) =&gt; 1983
(uni-member-hire-date (make-compound 27 42 98 'fire!)) =&gt; #f
</blockquote></pre>

<h2 id="implementation">Implementation</h2>

<p>The sample implementation is available in the GitHub repository.</p>

<h2 id="acknowledgements">Acknowledgements</h2>

<p>Thanks to the participants on the mailing list.</p>

<h2 id="copyright">Copyright</h2>
<p>&copy; 2021 John Cowan, Arvydas Silanskas.</p>

<p>
  Permission is hereby granted, free of charge, to any person
  obtaining a copy of this software and associated documentation files
  (the "Software"), to deal in the Software without restriction,
  including without limitation the rights to use, copy, modify, merge,
  publish, distribute, sublicense, and/or sell copies of the Software,
  and to permit persons to whom the Software is furnished to do so,
  subject to the following conditions:</p>

<p>
  The above copyright notice and this permission notice (including the
  next paragraph) shall be included in all copies or substantial
  portions of the Software.</p>
<p>
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
  NONINFRINGEMENT.  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
  BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
  ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
  CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.</p>

  <hr>
  <address>Editor: <a href="mailto:srfi-editors+at+srfi+dot+schemers+dot+org">Arthur A. Gleckler</a></address></body></html>
